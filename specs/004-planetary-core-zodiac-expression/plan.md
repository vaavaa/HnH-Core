# Plan & Logic Review: 004 — Planetary Core + Zodiac Expression Layer

## Dependencies (current codebase)

- **10 planets**: В спеке 004 явно зафиксировано: **расширение эфемерид до 10 планет входит в объём 004**. В `hnh/astrology/ephemeris.py` сейчас 7 планет (Sun–Saturn); в рамках 004 добавить Uranus, Neptune, Pluto; natal и транзиты должны использовать все 10.
- **Дома**: В спеке 004 явно зафиксировано: **расчёт домов входит в объём 004**. Каждая планета должна иметь house position (1–12); система домов (Placidus / Equal / Whole Sign и т.д.) — конфигурируемая, конкретизация в tasks/план реализации.
- **Правители знаков**: Таблица зафиксирована в контракте [contracts/sign-rulers.md](contracts/sign-rulers.md): sign index 0–11, схемы Classical (7 планет) и Modern (10 планет), по умолчанию — Modern.

---

## Logic review

### Сильные стороны

- **Чёткое разделение ролей**: Поведение считают 32 параметра; зодиак — только интерпретация. Иерархия «планеты → аспекты → агрегация → 32 params → lifecycle → zodiac layer» однозначна и не даёт зодиаку влиять на физику.
- **Детерминизм**: Требование идентичного вывода при одинаковых входных данных и запрет стохастики согласованы со спеками 001/002/003 и replay.
- **Совместимость с 003**: Логи — orjson; O(1) на день и кеш натальных констант хорошо стыкуются с правилами производительности и циклов.
- **Lifecycle**: Явно сказано, что смерть/перерождение/трансценденция не зависят от зодиака; усталость может влиять только через «reduced planetary modulation», т.е. через уже существующую модель, а не через новый канал.

### Что уточнить

1. **Четыре измерения (intensity, stability, expressiveness, adaptability)**  
   Имеет смысл в контракте зафиксировать, как каждое из них выводится из «planetary_presence, ruler_strength, hard_aspects_weight, angular weighting, tension vs harmony» (хотя бы формула или веса в плане/ tasks), чтобы тесты на детерминизм и границы [0,1] были однозначными.
2. **dominant_element**  
   Элементы (Fire, Earth, Air, Water) — производные от знаков. Достаточно определить правило: по какой метрике по 12×4 выбирается «доминантный» элемент (например, по сумме intensity по знакам элемента или по знаку с макс. intensity).

### Риски

- **Объём**: 004 включает 10 планет, дома, таблицу правителей и формулы 12×4. Имеет смысл разбить на фазы в tasks: например, фаза 1 — 10 планет + дома + знак/дом на планету; фаза 2 — слой Z (правители, 12×4), логи, тесты.
- **Тесты replay**: Чтобы «consistency across replay» была проверяема, в replay-сигнатуру или лог должен входить либо сам вектор 12×4, либо `zodiac_summary_hash` (как в спеке), и тест должен сравнивать его между прогонами.

---

## Implementation outline (for tasks)

1. **Ephemeris**: Расширить до 10 планет (Uranus, Neptune, Pluto); единый список в одном месте; обновить natal/transits.
2. **Houses**: Ввести расчёт домов (JD + lat/lon → куспиды; система домов конфигурируемая, по умолчанию — зафиксировать в tasks). Для каждой планеты — sign index 0..11 из longitude; house 1–12 из куспидов.
3. **Rulers**: Константа SIGN_RULER[12] → planet name; strength of ruler из позиции и аспектов этой планеты.
4. **Z computation**: Модуль `zodiac_expression.py`: вход — позиции планет (и опционально дома), аспекты; выход — 12×4, все в [0,1]; без обращения к params_final/base.
5. **Logging**: Опциональные поля dominant_sign, dominant_element, sign_energy_vector, zodiac_summary_hash (orjson, xxhash для хеша).
6. **Tests**: 99% по модулю зодиака; детерминизм; границы; независимость от behavioral state; replay consistency.

---

## Summary

Логика спеки **последовательна**: зодиак — производный, только для интерпретации и маркетинга, не меняет поведение. Чтобы реализация была однозначной, в плане/контракте стоит зафиксировать: (1) 10 планет и при необходимости дома, (2) таблицу правителей, (3) формулы или веса для четырёх измерений по знакам, (4) правило dominant_element и (5) включение zodiac в replay/тесты.
