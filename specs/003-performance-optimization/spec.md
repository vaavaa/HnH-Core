# Feature Specification: Performance Optimization — orjson, xxhash, Loops

**Feature Branch**: `003-performance-optimization`  
**Created**: 2025-02-19  
**Status**: Draft  
**Цель**: Единообразная оптимизация выполнения кода в core: обязательное использование orjson и xxhash, максимальная оптимизация циклов.

---

## Clarifications

### Session 2025-02-19

- Q: Что считать «core path» / «core-модулями» для правил orjson, xxhash и циклов? → A: Весь пакет `hnh/` (включая core, state, modulation, logging, memory, interface, identity и т.д.). Тесты и scripts не входят в core.
- Q: Нужны ли в спецификации измеримые целевые показатели по производительности? → A: Один обязательный проверяемый критерий — отсутствие регрессии на выбранном бенчмарке (например, 002/phase9); остальные требования остаются качественными.
- Q: При замене hashlib на xxhash как поступать со совместимостью старых хешей? → A: Одномоментный breaking change: все хеши в hnh/ переходят на xxhash; старые значения не поддерживаются; контракт считается версией 002+.
- Q: NumPy — обязательная зависимость для векторизации или опциональная? → A: NumPy опционален: при наличии — в горячих путях использовать векторизацию; при отсутствии — допустим чистый Python (comprehensions, вынос инвариантов).
- Q: Включать ли в 003 подготовку к mypyc/C++ (типизация, граница core computation)? → A: Нет: 003 только orjson, xxhash, циклы; подготовка к mypyc/C++ — отдельная спекуляция позже (в правилах Cursor это уже зафиксировано для консистентности кода).

---

## 1. Objective

Унифицировать и зафиксировать требования к производительности кода:

- **JSON**: везде в core path использовать **orjson** (без stdlib `json`).
- **Хеширование**: везде использовать **xxhash** (xxh3_128 / xxh64) для идентичности, подписей, кеш-ключей.
- **Циклы**: максимально оптимизировать — векторизация (NumPy) где уместно; вынос инвариантов из циклов; предвыделение; избегать тяжёлых операций внутри циклов.

---

## 2. Scope

**Определение core:** для данной спецификации под «core» понимается весь пакет `hnh/`. Модули в `tests/` и `scripts/` не входят в core; правила orjson/xxhash/циклы для них не обязательны.

### In Scope

- Замена всех использований `json` на `orjson` в пакете `hnh/`.
- Замена всех использований hashlib/других хеш-функций на xxhash в пакете `hnh/` (identity, signatures, cache keys).
- Правила и ревью циклов: векторизация (при наличии NumPy), вынос инвариантов, предвыделение, запрет лишней сериализации в циклах. NumPy — опциональная зависимость: если установлен, в hot path использовать векторизацию; если нет — допустим чистый Python.
- Тесты/бенчмарки: проверка отсутствия stdlib json в core; при необходимости — регрессионные бенчмарки (orjson vs json, xxhash vs hashlib).
- Cursor rule (или аналог) для соблюдения правил при написании кода.

### Out of Scope

- Изменение контрактов API (только внутренняя реализация).
- Оптимизация сторонних библиотек.
- JIT/Cython без отдельного решения.
- Подготовка к mypyc / вынос в C++ (типизация hot path, граница core computation) — отдельная спекуляция позже; в 003 не входит.

---

## 3. User Scenarios & Testing

### User Story 1 — orjson только (Priority: P1)

Как разработчик, я хочу, чтобы весь JSON в core path сериализовался и парсился через **orjson**, чтобы получить предсказуемую производительность и единый контракт.

**Independent Test**: Статический/ручной поиск `import json` и `json.dumps`/`json.loads` в core-модулях — не допускаются; тест на использование orjson в логгере и replay.

**Acceptance Scenarios**:

1. **Given** любой core-модуль, **When** нужна сериализация/десериализация JSON, **Then** используется только `orjson` (с `OPT_SORT_KEYS` где нужна детерминированность).
2. **Given** core path логирования или replay, **Then** stdlib `json` не используется.

---

### User Story 2 — xxhash для всех хешей (Priority: P1)

Как разработчик, я хочу, чтобы все хеши (identity_hash, configuration_hash, подписи, кеш-ключи) считались через **xxhash**, чтобы ускорить критические пути.

**Independent Test**: Поиск `hashlib` в core — не допускается для новых хешей; существующие хеши мигрированы на xxhash; тесты идентичности и replay проходят.

**Acceptance Scenarios**:

1. **Given** необходимость вычислить хеш структуры, **When** код в core, **Then** используется xxhash (xxh3_128 или xxh64), вход для детерминизма — orjson.dumps(..., option=orjson.OPT_SORT_KEYS).
2. **Given** identity_hash / configuration_hash / memory_signature, **Then** реализация использует xxhash.

---

### User Story 3 — Оптимизация циклов (Priority: P2)

Как разработчик, я хочу, чтобы циклы в core были написаны по правилам: векторизация где возможно, вынос инвариантов, предвыделение, без лишних тяжёлых вызовов в цикле.

**Independent Test**: Ревью кода (и/или линтер/rule): горячие циклы не содержат json/orjson.dumps в итерации; инварианты вынесены; при наличии NumPy — числовые массивы обрабатываются векторизованно где это не ломает детерминизм.

**Acceptance Scenarios**:

1. **Given** цикл по массиву параметров/осей и установленный NumPy, **When** можно заменить на векторизованную операцию без потери детерминизма, **Then** используется векторизация; при отсутствии NumPy — допустим оптимизированный чистый Python (comprehensions, инварианты вынесены).
2. **Given** цикл, **When** внутри есть константа или повторный lookup, **Then** они вынесены за цикл.
3. **Given** цикл, **When** размер результата известен, **Then** по возможности используется предвыделение или comprehension без лишних append.

---

### Edge Cases

- Совместимость с существующими логами и replay: формат вывода orjson (OPT_SORT_KEYS) уже используется в 002 — сохранять.
- Миграция хешей: переход hashlib → xxhash — одномоментный breaking change; все хеши в `hnh/` переходят на xxhash; старые значения хешей (identity_hash, configuration_hash, memory_signature и т.д.) не поддерживаются; контракт после 003 считается версией 002+ (новые логи и replay не совместимы со старыми по значениям хешей).

---

## 4. Functional Requirements

- **FR-P1**: В core path для JSON допускается только orjson; stdlib json не используется.
- **FR-P2**: Все хеши в core (identity, config, memory, подписи) считаются через xxhash (xxh3_128 или xxh64).
- **FR-P3**: Циклы: при наличии NumPy — предпочитать векторизацию в hot path; выносить инварианты; не вызывать orjson.dumps/hash в цикле без необходимости; предвыделение/comprehensions.
- **FR-P4**: NumPy — опциональная зависимость: если установлен, использовать векторизацию; если нет — допустим чистый Python (comprehensions, вынос инвариантов).

---

## 5. Performance Requirements

- orjson для всего JSON в core.
- xxhash для всех хешей в core.
- Критические циклы без сериализации и лишних lookup внутри итерации; векторизация где применимо.
- **Обязательный измеримый критерий:** отсутствие регрессии на референсном бенчмарке (например, `scripts/benchmark_002.py` / phase9 для 002). Остальные цели — качественные (без жёстких порогов по времени).

---

## 6. Test Requirements

- Тест/скрипт: в пакете `hnh/` нет `import json` и вызовов `json.dumps`/`json.loads`.
- Тест: ключевые хеши (identity_hash, configuration_hash) считаются через xxhash.
- **Обязательно:** прогон референсного бенчмарка (например, benchmark_002 / phase9) — регрессия не допускается. Остальные бенчмарки (orjson vs json, xxhash vs hashlib) — по желанию.

---

## 7. Deliverables

- Cursor rule (или проектное правило): orjson, xxhash, оптимизация циклов.
- Миграция оставшихся мест с json/hashlib на orjson/xxhash в core.
- Ревью/рефакторинг горячих циклов по правилам выше.
- Тесты/проверки на соблюдение правил; обязательный критерий приёмки — отсутствие регрессии на референсном бенчмарке (например, benchmark_002).

---

## 8. References

- Спецификация 002: §13 (orjson), §15 (performance), identity_hash (xxhash в identity.py).
- Проект: `hnh/core/identity.py`, `hnh/logging/state_logger_v2.py`, `hnh/state/replay_v2.py` — эталон использования orjson и xxhash.
